---
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: sdp-exporter
  namespace: sdp-devops
spec:
  selector:
    matchLabels:
      name: sdp-exporter
  template:
    metadata:
      labels:
        name: sdp-exporter
    spec:
      containers:
        - name: sdp-exporter
          image: wxext-registry.101.com/sdp/sdp-devops:v0.4.3
          command: ["/bin/sdp-exporter"]
          args:  [ "--excluding","container"]
          imagePullPolicy: Always
          env:
            - name: NUX_ROOTFS
              value: /host
          securityContext:
            privileged: true
            runAsUser: 0
          volumeMounts:
            - name: data
              mountPath: /data
              readOnly: true
            - name: docker-sock
              mountPath: /var/run/docker.sock
              readOnly: true
            - mountPath: /host/proc
              name: proc
              readOnly: true

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: sdp-exporter
  namespace: sdp-devops
  labels:
    name: sdp-exporter
data:
  exporter.conf: |
    port: 17000
    metricsPath: "/metrics"
    collector:
      exclude:
        - "container"
      config:
        diskUseCheck:
          monitor:
            - "/data"
        probeHttpStatusCode:
          timeOutSec: 10
          tlsConfig:
            x509KeyPair:
              - certFile: healthcheck-client.crt
                keyFile: healthcheck-client.key
                name: etcd-healthcheck-client
              - certFile: kube-admin.crt
                keyFile: kube-admin.key
                name: kube-admin
            insecureSkipVerify: true
          service:
            - targetURL: https://127.0.0.1:6443/healthz
              name: kube-apiserver
              nodeSelector:
                - kube-master
            - target: http://127.0.0.1:1988/health
              name: falcon-agent
